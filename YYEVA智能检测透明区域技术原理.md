# YYEVA智能检测透明区域技术原理

## 背景

&emsp;&emsp;随着YYEVA播放器被越来越多的开发者使用，我们团队也被提出了很多有用的建议，其中一个就是兼容不同布局方式的透明MP4。由于初期YYEVA播放器对透明MP4文件的颜色区域分布规则是左边彩色右边灰度（透明区域），对于没按照这样分布的透明MP4文件来说，播放器会播放异常。为了能更好地兼容外界的透明MP4文件，我们在播放器内部实现了智能颜色区域检测机制，用来判断透明MP4彩色区域和透明区域是如何分布，播放器才能正确截取相应区域，最后正常播放。



## 核心流程

&emsp;&emsp;获取视频帧 -> 视频帧区域采样像素点 -> 识别区域像素点颜色



## 详细解说

### 获取视频帧

&emsp;&emsp;通过AVFoundation框架来获取视频帧CMSampleBufferRef，因为行业通常是把MP4的像素格式设置成YUV，便于降低带宽，提高传输效率，所以这个CMSampleBufferRef也是YUV格式的，后续要转成RGB格式。

&emsp;&emsp;假如当前帧是被判断是无效帧（画面中没图像）的话，就按照步长为5来获取下一帧画面。这个步长的设置是因为有些视频有可能前10帧都是没画面，假如步长为1的话，就需要检测11次才能判断结果，这样会导致视频开始播放的时长变慢，影响效率。为了能在3次检测中就能检测出结果，我们就设置了每隔5帧取1帧的策略来提高检测效率，一般来说，一个视频在第10帧以后都会有画面的了。（这个步长可根据实际情况调节来改善检测效率）

![](http://lxcode.bs2cdn.yy.com/e7c26848-e54b-4081-bd0a-0f19369c4303.png)

### 视频帧区域采样像素点

&emsp;&emsp;我们对一个视频帧使用十字分成4个区域，分别是左上、左下、右上、右下。然后对每个区域进行6 * 6的网格化采样像素点，每个区域就是采样36个点，总共采样36 * 4 = 144个点。

<img src="http://lxcode.bs2cdn.yy.com/25dc00bb-4bab-4692-8c16-cd2a975fb95c.png" style="zoom:50%;" />

### 识别区域像素点颜色

&emsp;&emsp;我们判断每个区域是否含有彩色像素点来作为彩色区域。反之，不是彩色像素点就是灰度像素点。那么灰度像素点在RGB中是有这样的规则：

> 在 RGB 颜色空间中，每个像素由红色（R）、绿色（G）和蓝色（B）三个分量组成。如果 RGB 图像仅包含灰度图像，则每个像素的 R、G 和 B 分量应该相等或接近相等。
>
> 因此，可以通过计算每个像素的 R、G 和 B 分量的差异，来判断 RGB 图像是否仅包含灰度图像。如果这些差异非常小，则可以认为图像仅包含灰度图像。

&emsp;&emsp;而我们首先从区域采样点中提取每个像素的 R、G 和 B 分量。然后，我们计算这些分量之间的差异，并将其与一个阈值（例如 10）进行比较。如果差异较大，则可以认为图像不仅包含灰度图像，并且该方法将返回 NO。否则，该方法将返回 YES，表示图像仅包含灰度图像。

```
bool isGrayPixelWith(int r, int g, int b) {
    if (abs(r - g) > 10 || abs(g - b) > 10 || abs(b - r) > 10) {
        // 差异较大，不是灰度图像
        return NO;
    }
    // 差异较小，是灰度图像
    return YES;
}
```

&emsp;&emsp;在把4个区域按照上述的方法进行判断之后，就可以得出彩色区域和透明区域了，彩色区域就是只要有一个像素点是彩色的话，那就认为该区域就是彩色区域，否则就是透明区域。所以就有了以下结论：

```
if ( (左上彩色 || 左下彩色) && (右上灰度 && 右下灰度) ) {
  左彩色，右黑白
} else if ( (右上彩色 || 右下彩色) && (左上灰度 && 左下灰度) ) {
  左黑白，右彩色
} else if ( (左上彩色 || 右上彩色) && (左下灰度 && 右下灰度) ) {
  上彩色，下黑白
} else if ( (左下彩色 || 右下彩色) && (左上灰度 && 右上灰度) ) {
  上黑白，下彩色
}
```