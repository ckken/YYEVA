<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html" charset="UTF-8">
    <link href="src/css/style.css" rel="stylesheet" type="text/css" />
    <link href="src/css/main.css" rel="stylesheet" type="text/css" />
    <script src="src/assets/jquery.min.js"></script>
    <script src="src/assets/jquery.SuperSlide.2.1.1.js"></script>

</head>


<script type="text/javascript" src="./src/helpers/CSInterface.js"></script>
<script type="text/javascript" src="./src/helpers/CSInterfaceHelper.js"></script>


<script type="text/javascript" src="js/app.js"></script>


<script type="text/javascript">
    loadJSX("transform.jsx");
    loadJSX("utils.jsx");
    function alertMessage(message) {
        csInterface.evalScript("alertMessage('" + message + "');");
    }
</script>

<body >
    <script src="/demos/googlegg.js"></script>

     <script type="text/javascript">


        var infoUrl = 'https://raw.githubusercontent.com/yylive/YYEVA/main/AEP/versionFile';
        var infoName = nodePath.join(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), '.versionFile');

        //check 版本
  
        downloadFile(infoUrl, infoName, function () { 

            showModalUpgradeTip(true,"检测升级中")
            var newestVersion = parseInt(fs.readFileSync(infoName, 'utf-8'));
            var CURRENT_PROJECT_PATH = csInterface.getSystemPath(SystemPath.APPLICATION);
            var saveVersFile = nodePath.join(CURRENT_PROJECT_PATH, 'versionFile')
            var currentVersion = 0
            if (fs.existsSync(saveVersFile)) {
                 currentVersion = parseInt(fs.readFileSync(saveVersFile, 'utf-8'));
            }  
            fs.unlinkSync(infoName);
            if (currentVersion >= newestVersion) {
                showModalUpgradeTip(false,"检测升级中")
                return
            }
            if (currentVersion < newestVersion) { 
 
                confirmMessages("Hi，YYEVA插件有更新的版本了哦，更新一下? \\n tip: 下载过慢可以到官网下载最新版本安装哦。", function () {
                    
                    // var selectPathBtn = document.getElementById("selectPathBtn");
                    // selectPathBtn.disabled = true;
                    // var selectFile = document.getElementById("selectFile");
                    // selectFile.disabled = true; 
                    var zxpUrl = "https://raw.githubusercontent.com/yylive/YYEVA/main/AEP/build/2.1.1/YYYSMP4Conveter.zxp";
                    var zxpFile = nodePath.join(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), 'updateAE.zxp');
                    var ffmpegFile  
                    var ffmpegDonwloadFile
                    var ffmpegInExtensionFile 
                    showModalUpgradeTip(true,"升级中...\n下载ZXP安装包")              
                    downloadFile(zxpUrl, zxpFile, function () { 
                        showModalUpgradeTip(true,"升级中\n删除旧的ZXP安装包")              
                        deleteFloder(CURRENT_PROJECT_PATH, true, false, function () { 
                            ffmpegFile_zip = nodePath.join(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), 'ffmpeg.zip');
                            showModalUpgradeTip(true,"升级中\n解压缩zxp包") 
                            if (csInterface.getOSInformation().indexOf("Mac") >= 0) {
                                ffmpegFile = nodePath.join(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), 'ffmpeg');
                                ffmpegDonwloadFile =  "https://raw.githubusercontent.com/yylive/YYEVA/main/AEP/build/mac/ffmpeg.zip"; 
                                ffmpegInExtensionFile = nodePath.join(CURRENT_PROJECT_PATH, '/localbin/mac/ffmpeg')
                            } else { 
                                ffmpegDonwloadFile =  "https://raw.githubusercontent.com/yylive/YYEVA/main/AEP/build/windows/ffmpeg.zip"; 
                                ffmpegFile = nodePath.join(csInterface.getSystemPath(SystemPath.MY_DOCUMENTS), 'ffmpeg.exe');                                
                                ffmpegInExtensionFile = nodePath.join(CURRENT_PROJECT_PATH, '/localbin/windows/ffmpeg.exe')
                            } 
                            var zxpZipTool = new AdmZip(zxpFile)
                                zxpZipTool.extractAllTo(/*target path*/CURRENT_PROJECT_PATH , /*overwrite*/ true); 
                                var hasFmpg = fs.existsSync(ffmpegFile) 
                                   if (hasFmpg) {
                                    showModalUpgradeTip(true,"准备ffmpeg环境，大概几分钟就可以完成...拷贝中")
                                        fs.chmodSync(ffmpegFile,0o777)
                                       //拷贝过来
                                        fs.copyFileSync( ffmpegFile, ffmpegInExtensionFile, fs.constants.COPYFILE_EXCL)
                                        fs.unlinkSync(zxpFile);
                                        alertMessage("更新完成，即将重启。")
                                        csInterface.closeExtension()
                                    } else {
                                        showModalUpgradeTip(true,"准备ffmpeg环境，大概几分钟就可以完成...下载中")
                                        downloadFile(ffmpegDonwloadFile,ffmpegFile_zip, function () {
                                            var ffmpegZipTool = new AdmZip(ffmpegFile_zip)
                                            ffmpegZipTool.extractAllTo(/*target path*/csInterface.getSystemPath(SystemPath.MY_DOCUMENTS) , /*overwrite*/ true); 
                                            fs.chmodSync(ffmpegFile,0o777)     
                                            fs.copyFileSync(ffmpegFile, ffmpegInExtensionFile, fs.constants.COPYFILE_EXCL)
                                            fs.unlinkSync(zxpFile) 
                                            alertMessage("更新完成，即将重启。")
                                            csInterface.closeExtension()
                                        }) 
                                    } 
                        });
                    });
                }, function () {
                    showModalUpgradeTip(false,"检测升级中")
                });
            }
        });

    </script> 
     
    <script type="text/javascript">
        function copyText() {
            var copyText = document.getElementById("ae_help_h5");
            var textArea = document.createElement("textarea");
            textArea.value = copyText.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("Copy");
            textArea.remove();
        }
    </script>

    <div class="set-content">
        <!--    <div style="height: 40px;"></div>-->
        <div class="set-title hd">
            <ul class="clearfix">
                <li class="on">导出工具</li> 
                <li>导出日志</li>
                <li>预览</li>
            </ul>
        </div>
        <div class="set-middle bd">
            <ul class="set-middle-item">
                <li> 
                    <div role="tabpanel" class="tab-pane fade in active" id="Section1"> 
                        <div /> 
                        <br /> 
                        <button id="selectPath" onclick="selectPath()">选择路径</button>
                        <b id="outputtext">264、265输出路径为：</b>
                        <b id="pathtext">未设置</b>
                        <br />
                        <br />

                        <div id='outputtext'>档次选择</div>
                        <button class="lowLevelButton" onclick="selectLevel(0)">低</button>
                        <button class="midLevelButton" onclick="selectLevel(1)">中</button>
                        <button class="highLevelButton" onclick="selectLevel(2)">高</button>
                        <button class="customerButton" onclick="selectLevel(3)">自定义crf</button>
                        <input  type="number" id="customerCRFInput" class="customerCRFInput" value="23" step="1" min="0" max="51"></input>
                        <br />
                        <br />
                        <button id="converterBtn" onclick="beginConverter()">开始转换</button>
                    </div>
                </li>
            </ul>
            <ul class="set-middle-item">
                <li> 
                    <div role="tabpanel" class="tab-pane fade" id="Section2"> 
                        <button id="selectPath" onclick="selectLogPath()">选择路径</button>
                        <b id="outputtext">日志导出路径为：</b>
                        <b id="pathLogText">未设置</b>
                        <br />
                        <br />
                        <b id="outputLogtext">注：每一个AE资源都对应有一个插件日志目录，请确保当前打开的项目为所需日志的项目</b>
                        <br />
                        <br />
                        <button id="converterBtn" onclick="startOutputLog()">一键导出</button>
                    <br />
                     <br />
                    <div id="ae_ver_text">插件版本</div>
                    </div>
                </li>
            </ul>
                  
           <ul class="set-middle-item">
                <li>
                <div role="tabpanel" class="tab-pane fade in active" id="Section3">
                    <br /> 
                    <iframe scrolling="auto" style="position: absolute; width: 97%; height: 85%;" src="preview.html"></iframe>
                </div>
                </li>
            </ul>

        </div>
    </div>

    <div id="modal-overlay">
        <div id="modal-data">
            <p id="transform-tips">转换中...</p>
            <br />
            <p>转换过程中千万别切换合成！！！</p>
        </div>
    </div>

    <div id="modal-upgrade-overlay">
        <div id="modal-data">
            <p id="transform-upgrade-tips">检测新版本</p>
            <br />
            <p>耐心等待一会...</p>
        </div>
    </div>

    <div id="modal-log-overlay">
        <div id="modal-data">
            <p id="transform-tips">导出中...</p>
            <br />
            <p>大约需要一分钟，请耐心等待</p>
        </div>
    </div>

    <script>
        jQuery(".set-content").slide({
            autoPlay: false, trigger: "click", delayTime: 700, pnLoop: false, startFun: function () {
                cleanProject();
            }
        });
    </script>

</body>

</html>